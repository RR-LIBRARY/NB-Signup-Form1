<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Naveen Bharat (NB) - Join the Education Revolution</title>
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Import Google Fonts for NB Branding */
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Hind:wght@500&display=swap');

    :root {
      --nb-saffron: #FF9933;
      --nb-green: #138808;
      --nb-teal: #20B2AA; /* Used for focus states */
      --nb-dark: #333333;
      --nb-light-gray: #f0f0f0;
      --nb-border-gray: #ddd;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f5f5;
      margin: 0; /* Remove default body margin */
      padding: 0;
    }

    /* Demo Trigger Button Styles */
    .demo-trigger-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh; /* Center button vertically */
    }
    #openNBModal {
        padding: 15px 30px;
        background: var(--nb-saffron);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.3s, transform 0.2s;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    #openNBModal:hover {
        background: #e68a2e; /* Slightly darker saffron */
        transform: translateY(-2px);
    }


    /* NB Modal Container */
    .nb-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease; /* Smooth fade */
    }

    .nb-modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .nb-modal {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 550px; /* Slightly wider for better form layout */
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      transform: scale(0.95) translateY(20px); /* Start slightly smaller and lower */
      transition: transform 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.3s ease; /* Spring effect */
      opacity: 0;
      overflow: hidden; /* Prevent content spill during animation */
      display: flex;
      flex-direction: column;
      max-height: 90vh; /* Limit height on small screens */
    }

    .nb-modal-overlay.active .nb-modal {
      transform: scale(1) translateY(0); /* Scale up and move to final position */
      opacity: 1;
    }

    /* NB Modal Header */
    .nb-modal-header {
      background: linear-gradient(135deg, var(--nb-saffron), var(--nb-green));
      color: white;
      padding: 20px 25px;
      border-radius: 12px 12px 0 0;
      position: relative;
      flex-shrink: 0; /* Prevent header from shrinking */
    }

    .nb-modal-header h2 {
      margin: 0;
      font-size: 1.6rem; /* Adjusted size */
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }

    .nb-logo {
      font-weight: 700;
      font-family: 'Hind', sans-serif;
      background: white;
      color: var(--nb-green);
      padding: 4px 9px;
      border-radius: 6px;
      font-size: 1.1rem; /* Adjusted size */
      line-height: 1;
    }

    .nb-close-btn {
      position: absolute;
      top: 12px;
      right: 15px;
      background: none;
      border: none;
      color: white;
      font-size: 1.8rem; /* Larger close icon */
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
      opacity: 0.8;
      padding: 5px; /* Easier to click */
      line-height: 1;
    }

    .nb-close-btn:hover {
      transform: rotate(90deg);
      opacity: 1;
    }

    /* NB Modal Body */
    .nb-modal-body {
      padding: 20px 25px;
      overflow-y: auto; /* Allow scrolling if content overflows */
      flex-grow: 1; /* Allow body to take available space */
    }

    .nb-form-group {
      margin-bottom: 18px; /* Slightly reduced margin */
    }

    .nb-form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: var(--nb-dark);
      font-size: 0.95rem;
    }

    .nb-form-control {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid var(--nb-border-gray); /* Thinner border */
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
      box-sizing: border-box; /* Include padding and border in width */
    }

    .nb-form-control:focus {
      border-color: var(--nb-teal);
      outline: none;
      box-shadow: 0 0 0 3px rgba(32, 178, 170, 0.2);
    }

    /* Role Selector - NB Branded */
    .nb-role-selector {
      display: grid; /* Use grid for better alignment */
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Responsive columns */
      gap: 10px;
      margin-bottom: 20px;
    }

    .nb-role-option input[type="radio"] {
      display: none; /* Visually hide the radio button */
    }

    .nb-role-option label {
      display: block;
      padding: 10px;
      background: var(--nb-light-gray);
      border: 1px solid var(--nb-border-gray);
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--nb-dark); /* Explicitly set default text color */
    }
    .nb-role-option label:hover {
       background: #e0e0e0;
       border-color: #ccc;
    }

    .nb-role-option input[type="radio"]:checked + label {
      background: var(--nb-saffron);
      border-color: var(--nb-saffron);
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Conditional Fields (Dynamic) */
    .nb-dynamic-field {
      display: none; /* Hidden by default */
      animation: fadeIn 0.4s ease forwards; /* Use forwards to keep final state */
      margin-top: 18px; /* Space above dynamic field */
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Separator */
     .nb-separator {
        text-align: center;
        margin: 20px 0;
        color: #aaa;
        font-size: 0.9rem;
        position: relative;
     }
     .nb-separator::before,
     .nb-separator::after {
         content: '';
         position: absolute;
         top: 50%;
         width: 40%;
         height: 1px;
         background-color: #ddd;
     }
      .nb-separator::before { left: 0; }
      .nb-separator::after { right: 0; }


    /* NB Branded OAuth Buttons */
    .nb-oauth-buttons {
      display: flex;
      gap: 15px; /* Increased gap */
      margin-top: 10px;
      margin-bottom: 15px;
    }

    .nb-oauth-btn {
      flex: 1;
      padding: 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s;
      border: 1px solid var(--nb-border-gray);
      background: white;
      color: var(--nb-dark); /* Default color */
    }

    .nb-oauth-btn i {
        font-size: 1.2em; /* Slightly larger icons */
    }

    .nb-oauth-btn.google { }
     .nb-oauth-btn.google i { color: #DB4437; }
    .nb-oauth-btn.whatsapp { }
    .nb-oauth-btn.whatsapp i { color: #25D366; }

    .nb-oauth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      border-color: #bbb;
    }

    /* NB Modal Footer */
    .nb-modal-footer {
      display: flex;
      justify-content: flex-end; /* Align button to the right */
      padding: 15px 25px;
      border-top: 1px solid #eee;
      background-color: #f9f9f9; /* Subtle background */
      border-radius: 0 0 12px 12px;
       flex-shrink: 0; /* Prevent footer from shrinking */
    }

    .nb-btn {
      padding: 10px 20px; /* Adjusted padding */
      border-radius: 8px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
      border: none;
    }

    .nb-btn-primary {
      background: var(--nb-green);
      color: white;
    }

    .nb-btn-primary:hover {
      background: #0e7206; /* Darker green */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(19, 136, 8, 0.2);
    }

    /* Responsive Adjustments */
    @media (max-width: 480px) {
      .nb-modal { width: 95%; max-height: 95vh; }
      .nb-modal-header h2 { font-size: 1.4rem; }
      .nb-logo { font-size: 1rem; padding: 3px 7px; }
      .nb-modal-footer { padding: 15px; }
      .nb-btn { width: 100%; text-align: center; }
    }

     /* Add style for feedback messages */
    .nb-form-feedback {
        margin-top: 15px; padding: 10px 15px; border-radius: 6px;
        font-size: 0.9rem; display: none; /* Hidden by default */
    }
    .nb-form-feedback.success {
        background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb;
    }
    .nb-form-feedback.error {
        background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>

  <!-- Demo Trigger Button -->
  <div class="demo-trigger-container">
      <button id="openNBModal">
          Join NB EdRev
      </button>
  </div>


  <!-- NB Modal Structure -->
  <div class="nb-modal-overlay" id="nbModal">
    <div class="nb-modal">
      <div class="nb-modal-header">
        <h2><span class="nb-logo">NB</span> Join the Education Revolution</h2>
        <button class="nb-close-btn" id="closeNBModal" aria-label="Close modal">Ã—</button>
      </div>

      <div class="nb-modal-body">
        <!-- Using a form tag is semantically correct -->
        <form id="nbSignupForm">

            <div class="nb-form-group">
              <label>I am a:</label>
              <div class="nb-role-selector">
                <div class="nb-role-option">
                  <input type="radio" name="role" id="roleStudent" value="student" checked>
                  <label for="roleStudent">Student</label>
                </div>
                <div class="nb-role-option">
                  <input type="radio" name="role" id="roleEducator" value="educator">
                  <label for="roleEducator">Educator</label>
                </div>
                <div class="nb-role-option">
                  <input type="radio" name="role" id="roleParent" value="parent">
                  <label for="roleParent">Parent</label>
                </div>
              </div>
            </div>

            <div class="nb-form-group">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" name="fullName" class="nb-form-control" placeholder="Enter your full name" required>
            </div>
            <div class="nb-form-group">
                <label for="email">Email Address</label>
                <input type="email" id="email" name="email" class="nb-form-control" placeholder="you@example.com" required>
            </div>
             <div class="nb-form-group">
                <label for="mobile">Mobile Number</label>
                <input type="tel" id="mobile" name="mobile" class="nb-form-control" placeholder="Enter 10-digit mobile number" pattern="[0-9]{10}" required>
            </div>

            <div id="dynamicFieldsContainer">
                <div class="nb-dynamic-field" id="studentFields">
                    <div class="nb-form-group">
                        <label for="grade">Grade / Class</label>
                        <input type="text" id="grade" name="grade" class="nb-form-control" placeholder="e.g., Class 10, College Freshman">
                    </div>
                </div>
                <div class="nb-dynamic-field" id="educatorFields">
                    <div class="nb-form-group">
                        <label for="subject">Subject(s) Taught</label>
                        <input type="text" id="subject" name="subject" class="nb-form-control" placeholder="e.g., Mathematics, Physics">
                    </div>
                     <div class="nb-form-group">
                        <label for="experience">Years of Experience</label>
                        <input type="number" id="experience" name="experience" class="nb-form-control" placeholder="e.g., 5" min="0">
                    </div>
                </div>
                <div class="nb-dynamic-field" id="parentFields">
                    <div class="nb-form-group">
                        <label for="childName">Child's Name</label>
                        <input type="text" id="childName" name="childName" class="nb-form-control" placeholder="Enter your child's name">
                    </div>
                     <div class="nb-form-group">
                        <label for="childGrade">Child's Grade / Class</label>
                        <input type="text" id="childGrade" name="childGrade" class="nb-form-control" placeholder="e.g., Class 8">
                    </div>
                </div>
            </div>

            <div class="nb-separator">OR Sign up with</div>
            <div class="nb-oauth-buttons">
                <button type="button" class="nb-oauth-btn google">
                    <i class="fab fa-google"></i> Google
                </button>
                <button type="button" class="nb-oauth-btn whatsapp">
                    <i class="fab fa-whatsapp"></i> WhatsApp
                </button>
            </div>

            <!-- Feedback Area -->
            <div id="formFeedback" class="nb-form-feedback"></div>

        </form> <!-- End of form -->
      </div> <!-- End of modal body -->

      <div class="nb-modal-footer">
        <!-- Submit Button -->
        <button type="submit" form="nbSignupForm" class="nb-btn nb-btn-primary" id="submitBtn">Register Now</button>
      </div>
    </div> <!-- End of modal -->
  </div> <!-- End of modal overlay -->

  <script>
    // Ensure the entire script runs after the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', () => {
      // Get references to DOM elements
      const openModalBtn = document.getElementById('openNBModal');
      const closeModalBtn = document.getElementById('closeNBModal');
      const modalOverlay = document.getElementById('nbModal');
      // Ensure modalOverlay exists before querying inside it
      const modal = modalOverlay ? modalOverlay.querySelector('.nb-modal') : null;
      const roleRadios = document.querySelectorAll('input[name="role"]');
      const dynamicFieldsContainer = document.getElementById('dynamicFieldsContainer');
      const allDynamicFields = dynamicFieldsContainer ? dynamicFieldsContainer.querySelectorAll('.nb-dynamic-field') : [];
      const signupForm = document.getElementById('nbSignupForm');
      const formFeedback = document.getElementById('formFeedback');
      const submitBtn = document.getElementById('submitBtn');

      // Function to show/hide role-specific fields
      function updateDynamicFields() {
        // Check if required elements exist
        if (!roleRadios.length || !allDynamicFields.length) return;

        const selectedRole = document.querySelector('input[name="role"]:checked')?.value;
        if (!selectedRole) return; // Exit if no role selected

        // Hide all dynamic field sections first
        allDynamicFields.forEach(field => {
          if (field) field.style.display = 'none';
        });

        // Show the relevant field section for the selected role
        const relevantField = document.getElementById(`${selectedRole}Fields`);
        if (relevantField) {
          relevantField.style.display = 'block';
        }
      }

      // Function to display feedback messages (success/error)
      function showFeedback(message, type = 'error') {
        if (!formFeedback) return; // Check if feedback element exists
        formFeedback.textContent = message;
        formFeedback.className = `nb-form-feedback ${type}`; // Apply class for styling
        formFeedback.style.display = 'block'; // Make feedback visible
      }

      // Function to hide feedback messages
      function hideFeedback() {
        if (!formFeedback) return; // Check if feedback element exists
        formFeedback.style.display = 'none';
        formFeedback.textContent = '';
        formFeedback.className = 'nb-form-feedback';
      }

      // --- Event Listeners Setup ---

      // Open Modal Button
      if (openModalBtn && modalOverlay) {
        openModalBtn.addEventListener('click', () => {
          modalOverlay.classList.add('active'); // Show the modal overlay
          hideFeedback();                     // Clear any previous feedback
          updateDynamicFields();              // Show correct fields based on default role
        });
      }

      // Close Modal Button (Top Right 'X')
      if (closeModalBtn && modalOverlay) {
        closeModalBtn.addEventListener('click', () => {
          modalOverlay.classList.remove('active'); // Hide the modal overlay
        });
      }

      // Close Modal by clicking on the overlay background
      if (modalOverlay) {
        modalOverlay.addEventListener('click', (event) => {
          // Check if the click was directly on the overlay, not on the modal content
          if (event.target === modalOverlay) {
            modalOverlay.classList.remove('active'); // Hide the modal overlay
          }
        });
      }

      // Close Modal using the Escape key
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && modalOverlay && modalOverlay.classList.contains('active')) {
          modalOverlay.classList.remove('active'); // Hide the modal overlay
        }
      });

      // Update dynamic fields when the role selection changes
      if (roleRadios.length > 0) {
          roleRadios.forEach(radio => {
            radio.addEventListener('change', () => {
                updateDynamicFields(); // Show/hide appropriate fields
                hideFeedback();        // Clear feedback if role changes
            });
          });
      }


      // --- Handle Form Submission ---
      if(signupForm && submitBtn) { // Ensure form and submit button exist
        signupForm.addEventListener('submit', async (event) => { // Use async for await
            event.preventDefault(); // Stop default browser form submission
            hideFeedback(); // Clear previous messages
            submitBtn.disabled = true; // Disable button to prevent multiple clicks
            submitBtn.textContent = 'Registering...'; // Provide user feedback

            // Use HTML5 validation first
            if (!signupForm.checkValidity()) {
                console.log('Form validation failed (HTML5).');
                // Show general feedback message
                showFeedback('Please fill in all required fields correctly.', 'error');
                // Optionally trigger browser's own validation UI bubbles
                signupForm.reportValidity();
                // Re-enable button and restore text
                submitBtn.disabled = false;
                submitBtn.textContent = 'Register Now';
                return; // Stop the submission process
            }

            // Collect data from the form
            const formData = new FormData(signupForm);
            const data = {};
            formData.forEach((value, key) => { data[key] = value; });

            // --- START OF FIX for closest error ---
            // Clean up data: Remove fields not relevant to the selected role
            const selectedRole = data.role;
            const fieldsToDelete = []; // Array to store keys of fields to be removed

            // Iterate over the keys in the collected data object
            Object.keys(data).forEach(key => {
                // Always keep these common fields and the role itself
                if (key === 'role' || key === 'fullName' || key === 'email' || key === 'mobile') {
                    return; // Skip to the next key
                }

                // Get the corresponding form element
                const inputElement = signupForm.elements[key];

                // Crucial Check: Ensure inputElement exists and has the 'closest' method
                // This handles cases like RadioNodeList for 'role' which doesn't have 'closest'
                // and ensures we only check actual input/select/textarea elements.
                if (inputElement && typeof inputElement.closest === 'function') {
                    // Find the nearest parent with the class '.nb-dynamic-field'
                    const parentDynamicField = inputElement.closest('.nb-dynamic-field');

                    // If the element is inside a dynamic field section,
                    // and that section's ID doesn't match the selected role's field section ID
                    if (parentDynamicField && parentDynamicField.id !== `${selectedRole}Fields`) {
                        // Mark this key for deletion as it belongs to an unselected role
                        fieldsToDelete.push(key);
                    }
                }
            });

            // Remove the marked fields from the data object
            fieldsToDelete.forEach(key => {
                delete data[key];
            });
            // --- END OF FIX ---

            console.log('Sending cleaned data:', data); // Log data being sent

            // Send data to the backend using Fetch API
            try {
                const response = await fetch('/register', { // Target the Flask endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // We are sending JSON data
                    },
                    body: JSON.stringify(data), // Convert JS object to JSON string
                });

                const result = await response.json(); // Parse the JSON response from Flask

                // Check if the request was successful (status code 2xx)
                if (response.ok) {
                    console.log('Server response (Success):', result);
                    // Show success message from the server or a default one
                    showFeedback(result.message || 'Registration successful!', 'success');
                    // Optionally: Reset the form after successful submission
                    // signupForm.reset();
                    // Optionally: Update dynamic fields if form is reset
                    // updateDynamicFields();
                    // Optionally: Close the modal after a delay
                    // setTimeout(() => { if (modalOverlay) modalOverlay.classList.remove('active'); }, 3000);
                } else {
                    // Handle server-side errors (e.g., validation failure, internal error)
                    console.error('Server response (Error):', result);
                    // Show error message from the server or a default one
                    showFeedback(result.message || 'Registration failed. Please try again.', 'error');
                }

            } catch (error) {
                // Handle network errors (e.g., server down, no connection)
                console.error('Fetch error:', error);
                showFeedback('An error occurred. Please check your connection and try again.', 'error');
            } finally {
                 // This block runs regardless of success or error
                 // Re-enable the submit button and restore its original text
                submitBtn.disabled = false;
                submitBtn.textContent = 'Register Now';
            }
        });
      }

       // --- OAuth Button Placeholders ---
       const oauthButtons = document.querySelectorAll('.nb-oauth-btn');
       if (oauthButtons.length > 0) {
           oauthButtons.forEach(button => {
               button.addEventListener('click', () => {
                   const provider = button.classList.contains('google') ? 'Google' : 'WhatsApp';
                   console.log(`${provider} Sign-in clicked`);
                   // Placeholder alert - actual implementation would redirect/popup
                   alert(`${provider} sign-in flow is not implemented in this demo.`);
               });
           });
       }


      // --- Initial Setup ---
      // Run updateDynamicFields on page load in case the modal starts open
      // or if the default checked radio needs its fields shown initially.
      updateDynamicFields();

    }); // End of DOMContentLoaded listener
  </script>

</body>
</html>